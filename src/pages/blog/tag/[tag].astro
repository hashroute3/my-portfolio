---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  const tagSet = new Set(posts.flatMap((p) => p.data.tags));
  return Array.from(tagSet).map((tag) => ({
    params: { tag: tag.toLowerCase().replace(/\s+/g, '-') },
    props: { tag, displayTag: tag },
  }));
}

const { tag, displayTag } = Astro.props;
const allPosts = (await getCollection('blog'))
  .filter((p) => !p.data.draft && p.data.tags.includes(displayTag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
---

<BaseLayout title={`Blog: ${displayTag}`} description={`Blog posts tagged with ${displayTag}.`}>
  <article class="mx-auto max-w-5xl px-6 py-16">
    <header>
      <h1 class="font-serif text-3xl font-semibold text-surface-50">Tag: {displayTag}</h1>
      <p class="mt-2 text-surface-400">{allPosts.length} post{allPosts.length === 1 ? '' : 's'}.</p>
    </header>
    <ul class="mt-12 space-y-8" role="list">
      {allPosts.map((entry) => {
        const readingTime = Math.max(1, Math.ceil((entry.body.length / 1000) * 2));
        return (
          <li class="rounded-xl border border-surface-800 bg-surface-900/50 p-6 transition-colors hover:border-surface-700">
            <a href={`/blog/${entry.slug}/`} class="block">
              <h2 class="font-serif text-lg font-semibold text-surface-50 transition-colors hover:text-sky-400">
                {entry.data.title}
              </h2>
              <p class="mt-2 text-sm text-surface-400">
                <time datetime={entry.data.publishDate.toISOString()}>
                  {entry.data.publishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
                <span class="mx-2">Â·</span>
                <span>{readingTime} min read</span>
              </p>
              <p class="mt-2 text-surface-300">{entry.data.description}</p>
            </a>
          </li>
        );
      })}
    </ul>
  </article>
</BaseLayout>
