---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = (await getCollection('blog'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
const tags = [...new Set(allPosts.flatMap((p) => p.data.tags))].sort();
---

<BaseLayout title="Blog" description="Technical and research-oriented blog posts.">
  <article class="mx-auto max-w-5xl px-6 py-16">
    <header>
      <h1 class="font-serif text-3xl font-semibold text-surface-50">Blog</h1>
      <p class="mt-2 text-surface-400">Technical and research-oriented writing.</p>
    </header>

    {tags.length > 0 && (
      <div class="mt-8 flex flex-wrap gap-2" aria-label="Tags">
        {tags.map((tag) => (
          <a
            href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}/`}
            class="rounded-full border border-surface-700 bg-surface-800/50 px-3 py-1 text-sm text-surface-300 transition-colors hover:border-surface-600 hover:text-surface-100"
          >
            {tag}
          </a>
        ))}
      </div>
    )}

    <ul class="mt-12 space-y-8" role="list">
      {allPosts.map((entry) => {
        const readingTime = Math.max(1, Math.ceil((entry.body.length / 1000) * 2));
        return (
          <li class="rounded-xl border border-surface-800 bg-surface-900/50 p-6 transition-colors hover:border-surface-700">
            <a href={`/blog/${entry.slug}/`} class="block">
              <h2 class="font-serif text-lg font-semibold text-surface-50 transition-colors hover:text-sky-400">
                {entry.data.title}
              </h2>
              <p class="mt-2 text-sm text-surface-400">
                <time datetime={entry.data.publishDate.toISOString()}>
                  {entry.data.publishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
                <span class="mx-2">Â·</span>
                <span>{readingTime} min read</span>
              </p>
              <p class="mt-2 text-surface-300">{entry.data.description}</p>
              {entry.data.tags.length > 0 && (
                <div class="mt-3 flex flex-wrap gap-2">
                  {entry.data.tags.map((tag) => (
                    <span class="rounded bg-surface-800 px-1.5 py-0.5 text-xs text-surface-400">{tag}</span>
                  ))}
                </div>
              )}
            </a>
          </li>
        );
      })}
    </ul>

    {allPosts.length === 0 && (
      <p class="mt-12 text-surface-500">No posts yet. Add markdown or MDX in <code class="rounded bg-surface-800 px-1.5 py-0.5">src/content/blog/</code>.</p>
    )}
  </article>
</BaseLayout>
