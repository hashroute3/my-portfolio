---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPapers = (await getCollection('papers')).sort((a, b) => b.data.year - a.data.year);
const years = [...new Set(allPapers.map((p) => p.data.year))].sort((a, b) => b - a);
const topics = [...new Set(allPapers.map((p) => p.data.topic))].sort();
---

<BaseLayout title="Authored Papers" description="Formal papers with abstracts, citations, and PDFs.">
  <article class="mx-auto max-w-5xl px-6 py-16">
    <header>
      <h1 class="font-serif text-3xl font-semibold text-surface-50">Authored Papers</h1>
      <p class="mt-2 text-surface-400">Formal papers with abstracts, citations, and links.</p>
    </header>

    <aside class="mt-8 flex flex-wrap gap-4" aria-label="Filters">
      <div>
        <label for="year-filter" class="sr-only">Filter by year</label>
        <select
          id="year-filter"
          class="rounded-lg border border-surface-700 bg-surface-900 px-3 py-2 text-sm text-surface-200 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          data-filter="year"
        >
          <option value="">All years</option>
          {years.map((y) => (
            <option value={y}>{y}</option>
          ))}
        </select>
      </div>
      <div>
        <label for="topic-filter" class="sr-only">Filter by topic</label>
        <select
          id="topic-filter"
          class="rounded-lg border border-surface-700 bg-surface-900 px-3 py-2 text-sm text-surface-200 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          data-filter="topic"
        >
          <option value="">All topics</option>
          {topics.map((t) => (
            <option value={t}>{t}</option>
          ))}
        </select>
      </div>
    </aside>

    <ul class="mt-12 space-y-8" role="list" id="papers-list">
      {allPapers.map((entry) => (
        <li
          class="paper-item rounded-xl border border-surface-800 bg-surface-900/50 p-6 transition-colors hover:border-surface-700"
          data-year={entry.data.year}
          data-topic={entry.data.topic}
        >
          <h2 class="font-serif text-lg font-semibold text-surface-50">
            {entry.data.title}
          </h2>
          <p class="mt-2 text-sm text-surface-400">
            <span class="font-medium text-surface-300">{entry.data.venue}</span>
            <span class="mx-2">·</span>
            <span>{entry.data.year}</span>
            <span class="mx-2">·</span>
            <span class="rounded bg-surface-800 px-1.5 py-0.5 text-xs text-surface-400">{entry.data.topic}</span>
          </p>
          <p class="mt-3 text-surface-300">
            {entry.data.abstract}
          </p>
          {entry.data.citation && (
            <blockquote class="mt-4 border-l-2 border-surface-700 pl-4 text-sm italic text-surface-400">
              {entry.data.citation}
            </blockquote>
          )}
          <div class="mt-4 flex flex-wrap gap-3">
            {entry.data.pdfUrl && (
              <a href={entry.data.pdfUrl} class="text-sm text-sky-400 hover:underline" target="_blank" rel="noopener">
                PDF
              </a>
            )}
            {entry.data.externalUrl && (
              <a href={entry.data.externalUrl} class="text-sm text-sky-400 hover:underline" target="_blank" rel="noopener">
                External link
              </a>
            )}
            {entry.data.doi && (
              <a href={`https://doi.org/${entry.data.doi}`} class="text-sm text-sky-400 hover:underline" target="_blank" rel="noopener">
                DOI
              </a>
            )}
          </div>
        </li>
      ))}
    </ul>

    {allPapers.length === 0 && (
      <p class="mt-12 text-surface-500">No papers yet. Add markdown files in <code class="rounded bg-surface-800 px-1.5 py-0.5">src/content/papers/</code>.</p>
    )}
  </article>

  <script>
    const yearSelect = document.getElementById('year-filter');
    const topicSelect = document.getElementById('topic-filter');
    const items = document.querySelectorAll('.paper-item');

    function filter() {
      const year = yearSelect?.value;
      const topic = topicSelect?.value;
      items.forEach((el) => {
        const matchYear = !year || el.getAttribute('data-year') === year;
        const matchTopic = !topic || el.getAttribute('data-topic') === topic;
        (el as HTMLElement).style.display = matchYear && matchTopic ? '' : 'none';
      });
    }
    yearSelect?.addEventListener('change', filter);
    topicSelect?.addEventListener('change', filter);
  </script>
</BaseLayout>
